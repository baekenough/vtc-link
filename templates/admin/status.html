{% extends "base.html" %}

{% block title %}상태 - VTC-Link 관리{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">병원별 상태</h1>
    <p class="page-subtitle">연동된 병원의 실시간 처리 현황</p>
</div>

{% if status_list %}
<div class="status-grid">
    {% for item in status_list %}
    <div class="status-card">
        <div class="status-card-header">
            <span class="status-card-title">{{ item.hospital_id }}</span>
            <div class="status-indicator">
                {% if item.last_status == "success" %}
                <span class="status-dot online"></span>
                <span class="text-sm text-muted">정상</span>
                {% elif item.last_status == "error" %}
                <span class="status-dot offline"></span>
                <span class="text-sm text-muted">오류</span>
                {% elif item.last_status == "running" %}
                <span class="status-dot warning"></span>
                <span class="text-sm text-muted">실행중</span>
                {% else %}
                <span class="status-dot" style="background: var(--color-text-muted); animation: none;"></span>
                <span class="text-sm text-muted">대기</span>
                {% endif %}
            </div>
        </div>
        <div class="status-card-body">
            <div class="status-row">
                <span class="status-label">마지막 실행</span>
                <span class="status-value">{{ item.last_run_at | default("--") }}</span>
            </div>
            <div class="status-row">
                <span class="status-label">마지막 성공</span>
                <span class="status-value">{{ item.last_success_at | default("--") }}</span>
            </div>
            <div class="status-row">
                <span class="status-label">상태</span>
                <span class="status-value">
                    {% if item.last_status == "success" %}
                    <span class="badge badge-success">성공</span>
                    {% elif item.last_status == "error" %}
                    <span class="badge badge-error">오류</span>
                    {% elif item.last_status == "running" %}
                    <span class="badge badge-info">실행중</span>
                    {% else %}
                    <span class="badge badge-neutral">대기</span>
                    {% endif %}
                </span>
            </div>
            <div class="status-row">
                <span class="status-label">오류 코드</span>
                <span class="status-value">
                    {% if item.last_error_code %}
                    <span class="badge badge-error">{{ item.last_error_code }}</span>
                    {% else %}
                    --
                    {% endif %}
                </span>
            </div>
            <div class="status-row">
                <span class="status-label">후처리 실패 횟수</span>
                <span class="status-value">
                    {% if item.postprocess_fail_count and item.postprocess_fail_count > 0 %}
                    <span class="badge badge-warning">{{ item.postprocess_fail_count }}</span>
                    {% else %}
                    <span class="text-muted">0</span>
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="card mt-xl">
    <div class="card-header">
        <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </svg>
            전체 목록
        </h2>
        <span class="text-sm text-muted">총 {{ status_list | length }}개 병원</span>
    </div>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>병원 ID</th>
                    <th>마지막 실행</th>
                    <th>마지막 성공</th>
                    <th>상태</th>
                    <th>오류 코드</th>
                    <th>후처리 실패</th>
                </tr>
            </thead>
            <tbody>
                {% for item in status_list %}
                <tr>
                    <td class="cell-mono"><strong>{{ item.hospital_id }}</strong></td>
                    <td class="cell-timestamp">{{ item.last_run_at | default("--") }}</td>
                    <td class="cell-timestamp">{{ item.last_success_at | default("--") }}</td>
                    <td>
                        {% if item.last_status == "success" %}
                        <span class="badge badge-success">성공</span>
                        {% elif item.last_status == "error" %}
                        <span class="badge badge-error">오류</span>
                        {% elif item.last_status == "running" %}
                        <span class="badge badge-info">실행중</span>
                        {% else %}
                        <span class="badge badge-neutral">대기</span>
                        {% endif %}
                    </td>
                    <td class="cell-mono">
                        {% if item.last_error_code %}
                        <span class="badge badge-error">{{ item.last_error_code }}</span>
                        {% else %}
                        --
                        {% endif %}
                    </td>
                    <td class="cell-mono">
                        {% if item.postprocess_fail_count and item.postprocess_fail_count > 0 %}
                        <span class="text-accent">{{ item.postprocess_fail_count }}</span>
                        {% else %}
                        0
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% else %}
<div class="card">
    <div class="card-body">
        <div class="empty-state">
            <div class="empty-state-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                </svg>
            </div>
            <h3 class="empty-state-title">상태 정보 없음</h3>
            <p class="empty-state-text">아직 등록된 병원 상태 정보가 없습니다.</p>
        </div>
    </div>
</div>
{% endif %}

<div class="card mt-lg">
    <div class="card-header">
        <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            상태 안내
        </h2>
    </div>
    <div class="card-body">
        <div class="config-list">
            <div class="config-item">
                <div class="status-indicator">
                    <span class="status-dot online" style="animation: none;"></span>
                    <span>성공</span>
                </div>
                <span class="text-secondary">최근 실행이 정상적으로 완료됨</span>
            </div>
            <div class="config-item">
                <div class="status-indicator">
                    <span class="status-dot warning" style="animation: none;"></span>
                    <span>실행중</span>
                </div>
                <span class="text-secondary">현재 데이터 처리 진행 중</span>
            </div>
            <div class="config-item">
                <div class="status-indicator">
                    <span class="status-dot offline" style="animation: none;"></span>
                    <span>오류</span>
                </div>
                <span class="text-secondary">최근 실행에서 오류 발생</span>
            </div>
            <div class="config-item">
                <div class="status-indicator">
                    <span class="status-dot" style="background: var(--color-text-muted); animation: none;"></span>
                    <span>대기</span>
                </div>
                <span class="text-secondary">아직 실행 기록 없음</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}
